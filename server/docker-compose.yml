services:
    mysql:
        image: mysql:8.0
        container_name: drim-mysql
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-password}
            MYSQL_DATABASE: drim
            TZ: Asia/Shanghai
        ports:
            - '3306:3306'
        volumes:
            - mysql_data:/var/lib/mysql
        command: >
            --character-set-server=utf8mb4
            --collation-server=utf8mb4_unicode_ci
            --innodb-buffer-pool-size=48M
            --innodb-log-buffer-size=4M
            --innodb-flush-method=O_DIRECT
            --key-buffer-size=8M
            --max-connections=15
            --table-open-cache=64
            --thread-cache-size=4
            --tmp-table-size=8M
            --max-heap-table-size=8M
            --performance-schema=OFF
            --skip-log-bin
        healthcheck:
            test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${MYSQL_ROOT_PASSWORD:-password}']
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 60s
        mem_limit: 300m
        memswap_limit: 300m

    api:
        build:
            context: ..
            dockerfile: server/Dockerfile.monorepo
        container_name: drim-api
        restart: unless-stopped
        environment:
            NODE_ENV: production
            PORT: 3333
            DATABASE_URL: mysql://root:${MYSQL_ROOT_PASSWORD:-password}@mysql:3306/drim
            JWT_SECRET: ${JWT_SECRET}
            WECHAT_APPID: ${WECHAT_APPID}
            WECHAT_SECRET: ${WECHAT_SECRET}
            AI_API_KEY: ${AI_API_KEY}
            AI_BASE_URL: ${AI_BASE_URL}
            NODE_OPTIONS: --max-old-space-size=128
        ports:
            - '3333:3333'
        depends_on:
            mysql:
                condition: service_healthy
        mem_limit: 180m
        memswap_limit: 180m

volumes:
    mysql_data:
