// Prisma Schema for 梦见小程序

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 用户表
model User {
  id              String    @id @default(cuid())
  openId          String    @unique @map("open_id")
  unionId         String?   @map("union_id")
  nickname        String    @default("梦游者")
  avatar          String?   @db.VarChar(512)
  gender          Int       @default(0)
  phone           String?   @db.VarChar(20)
  isVip           Boolean   @default(false) @map("is_vip")
  vipExpireAt     DateTime? @map("vip_expire_at")
  luckyPoints     Int       @default(0) @map("lucky_points")
  consecutiveDays Int       @default(0) @map("consecutive_days")
  lastDreamDate   DateTime? @map("last_dream_date") @db.Date
  totalDreams     Int       @default(0) @map("total_dreams")
  totalTasks      Int       @default(0) @map("total_tasks")
  status          Int       @default(1)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  dreams        Dream[]
  tasks         Task[]
  orders        Order[]
  pointRecords  PointRecord[]
  adRecords     AdRecord[]
  achievements  UserAchievement[]

  @@index([unionId])
  @@index([createdAt])
  @@map("users")
}

// 梦境表
model Dream {
  id         String      @id @default(cuid())
  userId     String      @map("user_id")
  content    String      @db.Text
  tags       String?     @db.VarChar(255) // JSON数组存储
  emotion    String?     @db.VarChar(32)
  wordCount  Int         @default(0) @map("word_count")
  status     DreamStatus @default(pending)
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  deletedAt  DateTime?   @map("deleted_at")

  user     User      @relation(fields: [userId], references: [id])
  analysis Analysis?
  task     Task?

  @@index([userId, createdAt])
  @@index([status])
  @@map("dreams")
}

// 解析结果表
model Analysis {
  id             String         @id @default(cuid())
  dreamId        String         @unique @map("dream_id")
  userId         String         @map("user_id")
  status         AnalysisStatus @default(processing)
  theme          String?        @db.VarChar(128)
  interpretation String?        @db.Text
  fortuneScore   Int?           @map("fortune_score")
  fortuneTips    String?        @db.Text @map("fortune_tips") // JSON
  aiModel        String?        @db.VarChar(64) @map("ai_model")
  tokensUsed     Int?           @map("tokens_used")
  latency        Int?           // 响应时间ms
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  dream Dream @relation(fields: [dreamId], references: [id])

  @@index([userId, createdAt])
  @@map("analyses")
}

// 任务表
model Task {
  id             String     @id @default(cuid())
  userId         String     @map("user_id")
  dreamId        String     @unique @map("dream_id")
  type           String     @db.VarChar(16)
  content        String     @db.VarChar(256)
  rewardPoints   Int        @default(10) @map("reward_points")
  status         TaskStatus @default(pending)
  isDoubleReward Boolean    @default(false) @map("is_double_reward")
  completedAt    DateTime?  @map("completed_at")
  expireAt       DateTime   @map("expire_at")
  createdAt      DateTime   @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id])
  dream Dream @relation(fields: [dreamId], references: [id])

  @@index([userId])
  @@index([status, expireAt])
  @@map("tasks")
}

// 积分记录表
model PointRecord {
  id          BigInt    @id @default(autoincrement())
  userId      String    @map("user_id")
  type        PointType
  amount      Int
  balance     Int
  source      String    @db.VarChar(32)
  sourceId    String?   @db.VarChar(64) @map("source_id")
  description String?   @db.VarChar(128)
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("point_records")
}

// 订单表
model Order {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  orderNo       String      @unique @map("order_no")
  type          OrderType
  productId     String      @map("product_id")
  productName   String      @db.VarChar(64) @map("product_name")
  amount        Decimal     @db.Decimal(10, 2)
  payAmount     Decimal     @db.Decimal(10, 2) @map("pay_amount")
  status        OrderStatus @default(pending)
  payType       String?     @db.VarChar(16) @map("pay_type")
  transactionId String?     @db.VarChar(64) @map("transaction_id")
  paidAt        DateTime?   @map("paid_at")
  expireAt      DateTime    @map("expire_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("orders")
}

// VIP套餐表
model VipPlan {
  id            String   @id
  name          String   @db.VarChar(32)
  durationDays  Int      @map("duration_days")
  price         Decimal  @db.Decimal(10, 2)
  originalPrice Decimal  @db.Decimal(10, 2) @map("original_price")
  sortOrder     Int      @default(0) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("vip_plans")
}

// 广告记录表
model AdRecord {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id")
  adType    String   @db.VarChar(16) @map("ad_type")
  position  String   @db.VarChar(32)
  eventType String   @db.VarChar(16) @map("event_type")
  duration  Int?
  errorMsg  String?  @db.VarChar(256) @map("error_msg")
  token     String?  @db.VarChar(64)
  tokenUsed Boolean  @default(false) @map("token_used")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@map("ad_records")
}

// 成就定义表
model Achievement {
  id             String  @id
  name           String  @db.VarChar(64)
  description    String  @db.VarChar(256)
  icon           String  @db.VarChar(32)
  conditionType  String  @db.VarChar(32) @map("condition_type")
  conditionValue Int     @map("condition_value")
  rewardPoints   Int     @default(0) @map("reward_points")
  sortOrder      Int     @default(0) @map("sort_order")
  isActive       Boolean @default(true) @map("is_active")

  users UserAchievement[]

  @@map("achievements")
}

// 用户成就关联表
model UserAchievement {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")

  user        User        @relation(fields: [userId], references: [id])
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

// 系统配置表
model Config {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(64)
  value       String   @db.Text
  description String?  @db.VarChar(256)
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("configs")
}

// 枚举类型
enum DreamStatus {
  pending
  analyzed
  deleted
}

enum AnalysisStatus {
  processing
  completed
  failed
}

enum TaskStatus {
  pending
  completed
  expired
}

enum PointType {
  earn
  consume
}

enum OrderType {
  vip
}

enum OrderStatus {
  pending
  paid
  cancelled
  refunded
}
