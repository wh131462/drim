# 生产环境部署配置
# 使用方法:
# 1. 复制 .env.example 为 .env 并填入实际配置
# 2. 登录 GitHub Container Registry: docker login ghcr.io -u <username> -p <token>
# 3. 首次部署运行: ./scripts/deploy.sh setup
# 4. 后续更新运行: ./scripts/deploy.sh update

services:
    nginx:
        image: nginx:alpine
        container_name: drim-nginx
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - certbot_www:/var/www/certbot:ro
            - certbot_certs:/etc/letsencrypt:ro
        depends_on:
            - api
        deploy:
            resources:
                limits:
                    memory: 64M

    certbot:
        image: certbot/certbot
        container_name: drim-certbot
        volumes:
            - certbot_www:/var/www/certbot
            - certbot_certs:/etc/letsencrypt
        entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

    mysql:
        image: mysql:8.0
        container_name: drim-mysql
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_DATABASE: drim
            TZ: Asia/Shanghai
        volumes:
            - mysql_data:/var/lib/mysql
        command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --character-set-client-handshake=FALSE --init-connect='SET NAMES utf8mb4'
        healthcheck:
            test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${MYSQL_ROOT_PASSWORD}']
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: 512M

    api:
        # 从 GitHub Container Registry 拉取镜像
        image: ghcr.io/${GITHUB_REPOSITORY:-wh131462/drim}-api:latest
        container_name: drim-api
        restart: unless-stopped
        environment:
            NODE_ENV: production
            PORT: 3333
            BASE_URL: ${BASE_URL:-https://api.131462.cloud}
            DATABASE_URL: mysql://root:${MYSQL_ROOT_PASSWORD}@mysql:3306/drim
            JWT_SECRET: ${JWT_SECRET}
            WECHAT_APPID: ${WECHAT_APPID}
            WECHAT_SECRET: ${WECHAT_SECRET}
            WECHAT_REMINDER_TEMPLATE_ID: ${WECHAT_REMINDER_TEMPLATE_ID:-}
            AI_API_KEY: ${AI_API_KEY}
            AI_API_URL: ${AI_API_URL}
            AI_MODEL: ${AI_MODEL}
            AI_API_FORMAT: ${AI_API_FORMAT:-openai}
        volumes:
            - uploads_data:/app/uploads
        depends_on:
            mysql:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 384M

volumes:
    mysql_data:
    uploads_data:
    certbot_www:
    certbot_certs:
