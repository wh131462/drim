# 梦见小程序 - 前端开发指南

## 1. 项目结构

```
src/
├── api/                    # API 接口定义
│   ├── modules/            # 按模块划分
│   │   ├── user.ts         # 用户相关接口
│   │   ├── dream.ts        # 梦境相关接口
│   │   ├── analysis.ts     # 解析相关接口
│   │   ├── task.ts         # 任务相关接口
│   │   └── ad.ts           # 广告相关接口
│   ├── request.ts          # 请求封装
│   └── index.ts            # 统一导出
│
├── components/             # 公共组件
│   ├── base/               # 基础组件
│   │   ├── DButton.vue     # 按钮
│   │   ├── DInput.vue      # 输入框
│   │   ├── DModal.vue      # 弹窗
│   │   └── DLoading.vue    # 加载
│   ├── business/           # 业务组件
│   │   ├── DreamCard.vue   # 梦境卡片
│   │   ├── TagSelector.vue # 标签选择器
│   │   ├── EmotionPicker.vue # 情绪选择
│   │   ├── CalendarView.vue  # 日历视图
│   │   └── AnalysisCard.vue  # 解析卡片
│   └── layout/             # 布局组件
│       ├── NavBar.vue      # 导航栏
│       └── TabBar.vue      # 底部栏
│
├── composables/            # 组合式函数
│   ├── useUser.ts          # 用户相关
│   ├── useDream.ts         # 梦境相关
│   ├── useAd.ts            # 广告相关
│   ├── useAuth.ts          # 认证相关
│   └── useStorage.ts       # 存储相关
│
├── pages/                  # 页面
│   ├── index/              # 首页
│   ├── record/             # 记录梦境
│   ├── result/             # 解析结果
│   ├── profile/            # 我的
│   ├── dream-detail/       # 梦境详情
│   ├── vip/                # 会员
│   └── settings/           # 设置
│
├── stores/                 # Pinia 状态管理
│   ├── modules/
│   │   ├── user.ts         # 用户状态
│   │   ├── dream.ts        # 梦境状态
│   │   ├── task.ts         # 任务状态
│   │   └── config.ts       # 配置状态
│   └── index.ts
│
├── types/                  # TypeScript 类型定义
│   ├── user.d.ts
│   ├── dream.d.ts
│   ├── analysis.d.ts
│   ├── task.d.ts
│   └── api.d.ts
│
├── utils/                  # 工具函数
│   ├── date.ts             # 日期处理
│   ├── format.ts           # 格式化
│   ├── validate.ts         # 校验
│   ├── storage.ts          # 本地存储
│   └── report.ts           # 埋点上报
│
├── constants/              # 常量定义
│   ├── tags.ts             # 梦境标签
│   ├── emotions.ts         # 情绪类型
│   └── config.ts           # 配置常量
│
├── styles/                 # 样式文件
│   ├── variables.scss      # 变量定义
│   ├── mixins.scss         # 混入
│   └── common.scss         # 公共样式
│
├── static/                 # 静态资源
│   ├── images/
│   └── icons/
│
├── App.vue
├── main.ts
├── pages.json              # 页面配置
├── manifest.json           # 应用配置
└── uni.scss                # uni-app样式变量
```

## 2. 开发规范

### 2.1 命名规范

| 类型       | 规范                | 示例               |
| ---------- | ------------------- | ------------------ |
| 文件夹     | kebab-case          | `dream-detail/`    |
| 组件文件   | PascalCase          | `DreamCard.vue`    |
| 组合式函数 | camelCase + use前缀 | `useDream.ts`      |
| 工具函数   | camelCase           | `formatDate.ts`    |
| 类型文件   | camelCase + .d.ts   | `dream.d.ts`       |
| 常量       | UPPER_SNAKE_CASE    | `MAX_DREAM_LENGTH` |

### 2.2 组件规范

```vue
<!-- 组件模板规范 -->
<template>
    <view class="dream-card">
        <!-- 使用语义化类名 -->
        <view class="dream-card__header">
            <text class="dream-card__title">{{ title }}</text>
        </view>
        <view class="dream-card__content">
            <slot />
        </view>
    </view>
</template>

<script setup lang="ts">
// 1. 导入顺序：Vue -> 第三方 -> 内部模块
import { ref, computed, onMounted } from 'vue';
import { useUserStore } from '@/stores/modules/user';
import type { Dream } from '@/types/dream';

// 2. Props 定义
interface Props {
    title: string;
    dream?: Dream;
    showActions?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
    showActions: true
});

// 3. Emits 定义
interface Emits {
    (e: 'click', dream: Dream): void;
    (e: 'delete', id: string): void;
}

const emit = defineEmits<Emits>();

// 4. 响应式状态
const loading = ref(false);

// 5. 计算属性
const displayTitle = computed(() => {
    return props.title || '无标题';
});

// 6. 方法
function handleClick() {
    if (props.dream) {
        emit('click', props.dream);
    }
}

// 7. 生命周期
onMounted(() => {
    // 初始化逻辑
});
</script>

<style lang="scss" scoped>
.dream-card {
    padding: 24rpx;
    background: #fff;
    border-radius: 16rpx;

    &__header {
        margin-bottom: 16rpx;
    }

    &__title {
        font-size: 32rpx;
        font-weight: 500;
        color: #333;
    }

    &__content {
        font-size: 28rpx;
        color: #666;
    }
}
</style>
```

### 2.3 API 调用规范

```typescript
// src/api/modules/dream.ts
import { request } from '../request';
import type { Dream, DreamInput, DreamListResponse } from '@/types/dream';

export const dreamApi = {
    // 提交梦境
    create(data: DreamInput) {
        return request<Dream>({
            url: '/dream',
            method: 'POST',
            data
        });
    },

    // 获取列表
    getList(params: { page?: number; pageSize?: number }) {
        return request<DreamListResponse>({
            url: '/dream/list',
            method: 'GET',
            data: params
        });
    },

    // 获取详情
    getById(id: string) {
        return request<Dream>({
            url: `/dream/${id}`,
            method: 'GET'
        });
    },

    // 删除
    delete(id: string) {
        return request<void>({
            url: `/dream/${id}`,
            method: 'DELETE'
        });
    }
};
```

### 2.4 Store 规范

```typescript
// src/stores/modules/dream.ts
import { defineStore } from 'pinia';
import { dreamApi } from '@/api';
import type { Dream } from '@/types/dream';

interface DreamState {
    list: Dream[];
    current: Dream | null;
    loading: boolean;
    hasMore: boolean;
    page: number;
}

export const useDreamStore = defineStore('dream', {
    state: (): DreamState => ({
        list: [],
        current: null,
        loading: false,
        hasMore: true,
        page: 1
    }),

    getters: {
        todayDream: (state) => {
            const today = new Date().toDateString();
            return state.list.find((d) => new Date(d.createdAt).toDateString() === today);
        },
        hasTodayDream(): boolean {
            return !!this.todayDream;
        }
    },

    actions: {
        async fetchList(refresh = false) {
            if (this.loading) return;
            if (!refresh && !this.hasMore) return;

            this.loading = true;
            const page = refresh ? 1 : this.page;

            try {
                const { list, total } = await dreamApi.getList({ page, pageSize: 20 });

                if (refresh) {
                    this.list = list;
                } else {
                    this.list.push(...list);
                }

                this.page = page + 1;
                this.hasMore = this.list.length < total;
            } finally {
                this.loading = false;
            }
        },

        async submitDream(input: DreamInput) {
            const dream = await dreamApi.create(input);
            this.list.unshift(dream);
            this.current = dream;
            return dream;
        },

        clearCurrent() {
            this.current = null;
        }
    }
});
```

## 3. 页面配置

### 3.1 pages.json

```json
{
    "pages": [
        {
            "path": "pages/index/index",
            "style": {
                "navigationBarTitleText": "梦见",
                "navigationStyle": "custom"
            }
        },
        {
            "path": "pages/record/index",
            "style": {
                "navigationBarTitleText": "记录梦境"
            }
        },
        {
            "path": "pages/explore/index",
            "style": {
                "navigationBarTitleText": "探索",
                "enablePullDownRefresh": true
            }
        },
        {
            "path": "pages/dream-versions/index",
            "style": {
                "navigationBarTitleText": "版本历史"
            }
        },
        {
            "path": "pages/result/index",
            "style": {
                "navigationBarTitleText": "梦境解析",
                "navigationStyle": "custom"
            }
        },
        {
            "path": "pages/profile/index",
            "style": {
                "navigationBarTitleText": "我的",
                "navigationStyle": "custom"
            }
        },
        {
            "path": "pages/dream-detail/index",
            "style": {
                "navigationBarTitleText": "梦境详情"
            }
        },
        {
            "path": "pages/vip/index",
            "style": {
                "navigationBarTitleText": "开通会员"
            }
        },
        {
            "path": "pages/settings/index",
            "style": {
                "navigationBarTitleText": "设置"
            }
        }
    ],
    "globalStyle": {
        "navigationBarTextStyle": "black",
        "navigationBarTitleText": "梦见",
        "navigationBarBackgroundColor": "#FFFFFF",
        "backgroundColor": "#F5F5F5"
    },
    "tabBar": {
        "color": "#999999",
        "selectedColor": "#6B4EFF",
        "borderStyle": "black",
        "backgroundColor": "#FFFFFF",
        "list": [
            {
                "pagePath": "pages/index/index",
                "iconPath": "static/icons/home.png",
                "selectedIconPath": "static/icons/home-active.png",
                "text": "首页"
            },
            {
                "pagePath": "pages/explore/index",
                "iconPath": "static/icons/explore.png",
                "selectedIconPath": "static/icons/explore-active.png",
                "text": "探索"
            },
            {
                "pagePath": "pages/record/index",
                "iconPath": "static/icons/record.png",
                "selectedIconPath": "static/icons/record-active.png",
                "text": "记梦"
            },
            {
                "pagePath": "pages/profile/index",
                "iconPath": "static/icons/profile.png",
                "selectedIconPath": "static/icons/profile-active.png",
                "text": "我的"
            }
        ]
    }
}
```

## 4. 类型定义

### 4.1 用户类型

```typescript
// src/types/user.d.ts
export interface User {
    id: string;
    openId: string;
    nickname: string;
    avatar: string | null;
    gender: number;
    isVip: boolean;
    vipExpireAt: string | null;
    luckyPoints: number;
    consecutiveDays: number;
    totalDreams: number;
    totalTasks: number;
    createdAt: string;
}

export interface UserStats {
    totalDreams: number;
    totalAnalysis: number;
    totalTasks: number;
    taskCompletionRate: number;
    currentStreak: number;
    longestStreak: number;
    luckyPoints: number;
    achievements: Achievement[];
}

export interface Achievement {
    id: string;
    name: string;
    icon: string;
    unlockedAt: string;
}

export interface LoginParams {
    code: string;
}

export interface LoginResponse {
    token: string;
    expiresIn: number;
    userInfo: User;
    isNewUser: boolean;
}
```

### 4.2 梦境类型

```typescript
// src/types/dream.d.ts
export interface Dream {
    id: string;
    content: string;
    tags: string[];
    emotion: Emotion;
    status: DreamStatus;
    hasAnalysis: boolean;
    analysisId?: string;
    createdAt: string;
}

export interface DreamInput {
    content: string;
    tags?: string[];
    emotion?: Emotion;
}

export interface DreamDetail extends Dream {
    analysis?: Analysis;
}

export interface DreamListResponse {
    list: Dream[];
    total: number;
    page: number;
    pageSize: number;
}

export interface CalendarRecord {
    date: string;
    hasDream: boolean;
    dreamId: string | null;
}

export interface CalendarResponse {
    year: number;
    month: number;
    records: CalendarRecord[];
    consecutiveDays: number;
    monthTotal: number;
}

export type Emotion = 'happy' | 'fear' | 'confused' | 'sad';

export type DreamStatus = 'pending' | 'analyzed' | 'deleted';
```

### 4.3 AI润色类型 (新增)

```typescript
// src/types/polish.d.ts
export interface PolishRequest {
    dreamId: string;
    versionId?: string;
}

export interface PolishResponse {
    polishId: string;
    status: PolishStatus;
}

export interface PolishResult {
    polishId: string;
    dreamId: string;
    status: PolishStatus;
    originalVersion: string;
    polishedVersion: DreamVersion;
    quotaUsed: number;
    quotaRemaining: number;
}

export interface PolishQuota {
    total: number;
    used: number;
    remaining: number;
    resetAt: string;
    isVip: boolean;
}

export type PolishStatus = 'processing' | 'completed' | 'failed';
```

### 4.4 版本类型 (新增)

```typescript
// src/types/version.d.ts
export interface DreamVersion {
    versionId: string;
    type: VersionType;
    content: string;
    polishedFrom?: string;
    createdAt: string;
    isCurrent: boolean;
}

export interface VersionListResponse {
    dreamId: string;
    versions: DreamVersion[];
    total: number;
}

export type VersionType = 'original' | 'polished';
```

### 4.5 探索类型 (新增)

```typescript
// src/types/explore.d.ts
export interface PublicDream {
    dreamId: string;
    content: string;
    tags: string[];
    emotion: Emotion;
    author: {
        id: string;
        nickname: string;
        avatar: string;
    };
    likeCount: number;
    viewCount: number;
    createdAt: string;
}

export interface PublicDreamDetail extends PublicDream {
    analysis?: {
        theme: string;
        interpretation: string;
    };
    isLiked: boolean;
}

export interface ExploreListResponse {
    list: PublicDream[];
    total: number;
    page: number;
    pageSize: number;
}

export interface ExploreFilter {
    tags?: string[];
    emotion?: Emotion;
}
```

### 4.6 解析类型

```typescript
// src/types/analysis.d.ts
export interface Analysis {
    id: string;
    dreamId: string;
    status: AnalysisStatus;
    theme: string;
    interpretation: string;
    fortuneScore: number;
    fortuneTips: FortuneTips;
    task: TaskSummary;
    disclaimer: string;
    createdAt: string;
}

export interface FortuneTips {
    career: string;
    love: string;
    health: string;
}

export interface TaskSummary {
    id: string;
    type: TaskType;
    content: string;
    rewardPoints: number;
}

export interface AnalysisRequest {
    dreamId: string;
    adToken?: string;
}

export type AnalysisStatus = 'processing' | 'completed' | 'failed';
export type TaskType = 'wear' | 'food' | 'action';
```

## 5. 工具函数

### 5.1 日期处理

```typescript
// src/utils/date.ts
import dayjs from 'dayjs';
import 'dayjs/locale/zh-cn';
import relativeTime from 'dayjs/plugin/relativeTime';

dayjs.locale('zh-cn');
dayjs.extend(relativeTime);

export function formatDate(date: string | Date, format = 'YYYY-MM-DD') {
    return dayjs(date).format(format);
}

export function formatDateTime(date: string | Date) {
    return dayjs(date).format('YYYY-MM-DD HH:mm');
}

export function fromNow(date: string | Date) {
    return dayjs(date).fromNow();
}

export function isToday(date: string | Date) {
    return dayjs(date).isSame(dayjs(), 'day');
}

export function isYesterday(date: string | Date) {
    return dayjs(date).isSame(dayjs().subtract(1, 'day'), 'day');
}

export function getMonthDays(year: number, month: number) {
    return dayjs(`${year}-${month}`).daysInMonth();
}

export function getFirstDayOfMonth(year: number, month: number) {
    return dayjs(`${year}-${month}-01`).day();
}
```

### 5.2 埋点上报

```typescript
// src/utils/report.ts
interface ReportEvent {
    event: string;
    params?: Record<string, any>;
    timestamp?: number;
}

class Reporter {
    private queue: ReportEvent[] = [];
    private timer: number | null = null;

    // 上报事件
    track(event: string, params?: Record<string, any>) {
        this.queue.push({
            event,
            params,
            timestamp: Date.now()
        });

        this.flush();
    }

    // 批量上报
    private flush() {
        if (this.timer) return;

        this.timer = setTimeout(() => {
            if (this.queue.length > 0) {
                this.send(this.queue.splice(0, this.queue.length));
            }
            this.timer = null;
        }, 1000);
    }

    // 发送数据
    private send(events: ReportEvent[]) {
        // 发送到后端或第三方统计平台
        uni.request({
            url: '/api/report/events',
            method: 'POST',
            data: { events }
        });
    }

    // 页面浏览
    pageView(page: string, params?: Record<string, any>) {
        this.track('page_view', { page, ...params });
    }

    // 点击事件
    click(element: string, params?: Record<string, any>) {
        this.track('click', { element, ...params });
    }
}

export const reporter = new Reporter();

// 事件常量
export const Events = {
    APP_LAUNCH: 'app_launch',
    DREAM_RECORD_START: 'dream_record_start',
    DREAM_RECORD_SUBMIT: 'dream_record_submit',
    AD_SHOW: 'ad_show',
    AD_COMPLETE: 'ad_complete',
    ANALYSIS_VIEW: 'analysis_view',
    TASK_COMPLETE: 'task_complete',
    SHARE_CLICK: 'share_click',
    VIP_CLICK: 'vip_click',
    VIP_PURCHASE: 'vip_purchase'
};
```

## 6. 运行与构建

### 6.1 开发命令

```bash
# 安装依赖
pnpm install

# 开发 - H5
pnpm dev:h5

# 开发 - 微信小程序
pnpm dev:mp-weixin

# 构建 - H5
pnpm build:h5

# 构建 - 微信小程序
pnpm build:mp-weixin

# 类型检查
pnpm type-check

# 代码检查
pnpm lint
```

### 6.2 环境变量

```bash
# .env.development
VITE_API_BASE_URL=http://localhost:3333/api/v1
VITE_ENV=development

# .env.production
VITE_API_BASE_URL=https://api.drim.app/v1
VITE_ENV=production
```

## 7. 注意事项

### 7.1 性能优化

1. **图片懒加载**：列表页图片使用 `lazy-load` 属性
2. **分页加载**：长列表使用触底加载更多
3. **缓存策略**：合理使用本地存储缓存数据
4. **组件懒加载**：非首屏组件按需加载

### 7.2 兼容性

1. 测试覆盖微信小程序和 H5 两端
2. 注意 API 兼容性差异，使用 uni-app 条件编译
3. 样式单位统一使用 `rpx`

### 7.3 安全性

1. 敏感信息不存储在本地
2. Token 定期刷新
3. 用户输入做好校验和过滤
