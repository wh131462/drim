# æ¢¦è§å°ç¨‹åº - æ•°æ®åº“è®¾è®¡

## 1. æ•°æ®åº“é€‰å‹

| æ•°æ®åº“ | ç”¨é€” | è¯´æ˜ |
|--------|------|------|
| MySQL 8.x | å…³ç³»å‹æ•°æ® | ç”¨æˆ·ã€è®¢å•ã€é…ç½®ç­‰ç»“æ„åŒ–æ•°æ® |
| MongoDB 6.x | æ–‡æ¡£æ•°æ® | æ¢¦å¢ƒå†…å®¹ã€è§£æç»“æœç­‰éç»“æ„åŒ–æ•°æ® |
| Redis 7.x | ç¼“å­˜ | ä¼šè¯ã€çƒ­ç‚¹æ•°æ®ã€é™æµè®¡æ•° |

## 2. MySQL è¡¨è®¾è®¡

### 2.1 ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE `users` (
  `id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `open_id` VARCHAR(64) NOT NULL COMMENT 'å¾®ä¿¡OpenID',
  `union_id` VARCHAR(64) DEFAULT NULL COMMENT 'å¾®ä¿¡UnionID',
  `nickname` VARCHAR(64) DEFAULT 'æ¢¦æ¸¸è€…' COMMENT 'æ˜µç§°',
  `avatar` VARCHAR(512) DEFAULT NULL COMMENT 'å¤´åƒURL',
  `gender` TINYINT DEFAULT 0 COMMENT 'æ€§åˆ« 0æœªçŸ¥ 1ç”· 2å¥³',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·(åŠ å¯†)',
  `is_vip` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦VIP',
  `vip_expire_at` DATETIME DEFAULT NULL COMMENT 'VIPè¿‡æœŸæ—¶é—´',
  `lucky_points` INT DEFAULT 0 COMMENT 'å¹¸è¿å€¼ç§¯åˆ†',
  `consecutive_days` INT DEFAULT 0 COMMENT 'è¿ç»­è®°æ¢¦å¤©æ•°',
  `last_dream_date` DATE DEFAULT NULL COMMENT 'æœ€åè®°æ¢¦æ—¥æœŸ',
  `total_dreams` INT DEFAULT 0 COMMENT 'æ€»æ¢¦å¢ƒæ•°',
  `total_tasks` INT DEFAULT 0 COMMENT 'æ€»ä»»åŠ¡å®Œæˆæ•°',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ 1æ­£å¸¸ 0ç¦ç”¨',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_open_id` (`open_id`),
  KEY `idx_union_id` (`union_id`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### 2.2 ç”¨æˆ·æˆå°±è¡¨ (user_achievements)

```sql
CREATE TABLE `user_achievements` (
  `id` BIGINT AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `achievement_id` VARCHAR(32) NOT NULL COMMENT 'æˆå°±ID',
  `unlocked_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'è§£é”æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_achievement` (`user_id`, `achievement_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·æˆå°±è¡¨';
```

### 2.3 ç§¯åˆ†è®°å½•è¡¨ (point_records)

```sql
CREATE TABLE `point_records` (
  `id` BIGINT AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `type` ENUM('earn', 'consume') NOT NULL COMMENT 'ç±»å‹',
  `amount` INT NOT NULL COMMENT 'ç§¯åˆ†æ•°é‡',
  `balance` INT NOT NULL COMMENT 'å˜åŠ¨åä½™é¢',
  `source` VARCHAR(32) NOT NULL COMMENT 'æ¥æºç±»å‹',
  `source_id` VARCHAR(64) DEFAULT NULL COMMENT 'æ¥æºID',
  `description` VARCHAR(128) DEFAULT NULL COMMENT 'æè¿°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_source` (`source`, `source_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç§¯åˆ†è®°å½•è¡¨';
```

### 2.4 ä»»åŠ¡è¡¨ (tasks)

```sql
CREATE TABLE `tasks` (
  `id` VARCHAR(32) NOT NULL COMMENT 'ä»»åŠ¡ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `dream_id` VARCHAR(32) NOT NULL COMMENT 'å…³è”æ¢¦å¢ƒID',
  `analysis_id` VARCHAR(32) NOT NULL COMMENT 'å…³è”è§£æID',
  `type` VARCHAR(16) NOT NULL COMMENT 'ä»»åŠ¡ç±»å‹ wear/food/action',
  `content` VARCHAR(256) NOT NULL COMMENT 'ä»»åŠ¡å†…å®¹',
  `reward_points` INT DEFAULT 10 COMMENT 'å¥–åŠ±ç§¯åˆ†',
  `status` ENUM('pending', 'completed', 'expired') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `is_double_reward` TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦åŒå€å¥–åŠ±',
  `completed_at` DATETIME DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
  `expire_at` DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_dream_id` (`dream_id`),
  KEY `idx_status_expire` (`status`, `expire_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¹è¿ä»»åŠ¡è¡¨';
```

### 2.5 è®¢å•è¡¨ (orders)

```sql
CREATE TABLE `orders` (
  `id` VARCHAR(32) NOT NULL COMMENT 'è®¢å•ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `order_no` VARCHAR(64) NOT NULL COMMENT 'è®¢å•å·',
  `type` ENUM('vip') NOT NULL COMMENT 'è®¢å•ç±»å‹',
  `product_id` VARCHAR(32) NOT NULL COMMENT 'å•†å“ID',
  `product_name` VARCHAR(64) NOT NULL COMMENT 'å•†å“åç§°',
  `amount` DECIMAL(10, 2) NOT NULL COMMENT 'è®¢å•é‡‘é¢',
  `pay_amount` DECIMAL(10, 2) NOT NULL COMMENT 'å®ä»˜é‡‘é¢',
  `status` ENUM('pending', 'paid', 'cancelled', 'refunded') DEFAULT 'pending' COMMENT 'çŠ¶æ€',
  `pay_type` VARCHAR(16) DEFAULT NULL COMMENT 'æ”¯ä»˜æ–¹å¼',
  `transaction_id` VARCHAR(64) DEFAULT NULL COMMENT 'å¾®ä¿¡æ”¯ä»˜å•å·',
  `paid_at` DATETIME DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `expire_at` DATETIME NOT NULL COMMENT 'è®¢å•è¿‡æœŸæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';
```

### 2.6 VIPå¥—é¤è¡¨ (vip_plans)

```sql
CREATE TABLE `vip_plans` (
  `id` VARCHAR(32) NOT NULL COMMENT 'å¥—é¤ID',
  `name` VARCHAR(32) NOT NULL COMMENT 'å¥—é¤åç§°',
  `duration_days` INT NOT NULL COMMENT 'æœ‰æ•ˆå¤©æ•°',
  `price` DECIMAL(10, 2) NOT NULL COMMENT 'ä»·æ ¼',
  `original_price` DECIMAL(10, 2) NOT NULL COMMENT 'åŸä»·',
  `sort_order` INT DEFAULT 0 COMMENT 'æ’åº',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='VIPå¥—é¤è¡¨';

-- åˆå§‹æ•°æ®
INSERT INTO `vip_plans` (`id`, `name`, `duration_days`, `price`, `original_price`, `sort_order`) VALUES
('monthly', 'æœˆåº¦ä¼šå‘˜', 30, 9.90, 19.90, 1),
('quarterly', 'å­£åº¦ä¼šå‘˜', 90, 25.90, 59.70, 2),
('yearly', 'å¹´åº¦ä¼šå‘˜', 365, 79.90, 238.80, 3);
```

### 2.7 å¹¿å‘Šè®°å½•è¡¨ (ad_records)

```sql
CREATE TABLE `ad_records` (
  `id` BIGINT AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `user_id` VARCHAR(32) NOT NULL COMMENT 'ç”¨æˆ·ID',
  `ad_type` VARCHAR(16) NOT NULL COMMENT 'å¹¿å‘Šç±»å‹',
  `position` VARCHAR(32) NOT NULL COMMENT 'å¹¿å‘Šä½ç½®',
  `event_type` VARCHAR(16) NOT NULL COMMENT 'äº‹ä»¶ç±»å‹ show/complete/error',
  `duration` INT DEFAULT NULL COMMENT 'è§‚çœ‹æ—¶é•¿(ç§’)',
  `error_msg` VARCHAR(256) DEFAULT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `token` VARCHAR(64) DEFAULT NULL COMMENT 'å¹¿å‘Šå‡­è¯',
  `token_used` TINYINT(1) DEFAULT 0 COMMENT 'å‡­è¯æ˜¯å¦å·²ä½¿ç”¨',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_token` (`token`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¹¿å‘Šè®°å½•è¡¨';
```

### 2.8 é…ç½®è¡¨ (configs)

```sql
CREATE TABLE `configs` (
  `id` INT AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `key` VARCHAR(64) NOT NULL COMMENT 'é…ç½®é”®',
  `value` TEXT NOT NULL COMMENT 'é…ç½®å€¼(JSON)',
  `description` VARCHAR(256) DEFAULT NULL COMMENT 'æè¿°',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_key` (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç³»ç»Ÿé…ç½®è¡¨';

-- åˆå§‹é…ç½®
INSERT INTO `configs` (`key`, `value`, `description`) VALUES
('dream_tags', '[{"id":"chase","name":"è¿½é€","icon":"ğŸƒ"},{"id":"flying","name":"é£è¡Œ","icon":"ğŸ¦…"},{"id":"exam","name":"è€ƒè¯•","icon":"ğŸ“"},{"id":"family","name":"äº²äºº","icon":"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§"},{"id":"water","name":"æ°´","icon":"ğŸ’§"},{"id":"animal","name":"åŠ¨ç‰©","icon":"ğŸ•"},{"id":"lost","name":"è¿·è·¯","icon":"ğŸ—ºï¸"},{"id":"death","name":"æ­»äº¡","icon":"ğŸ’€"},{"id":"teeth","name":"ç‰™é½¿","icon":"ğŸ¦·"},{"id":"naked","name":"è£¸ä½“","icon":"ğŸ™ˆ"}]', 'æ¢¦å¢ƒæ ‡ç­¾é…ç½®'),
('emotions', '[{"id":"happy","name":"å¼€å¿ƒ","icon":"ğŸ˜Š"},{"id":"fear","name":"ææƒ§","icon":"ğŸ˜¨"},{"id":"confused","name":"å›°æƒ‘","icon":"ğŸ˜•"},{"id":"sad","name":"æ‚²ä¼¤","icon":"ğŸ˜¢"}]', 'æƒ…ç»ªé€‰é¡¹é…ç½®'),
('app_settings', '{"dreamMinLength":50,"dreamMaxLength":500,"reanalyzePointsCost":50}', 'åº”ç”¨è®¾ç½®');
```

### 2.9 æˆå°±å®šä¹‰è¡¨ (achievements)

```sql
CREATE TABLE `achievements` (
  `id` VARCHAR(32) NOT NULL COMMENT 'æˆå°±ID',
  `name` VARCHAR(64) NOT NULL COMMENT 'æˆå°±åç§°',
  `description` VARCHAR(256) NOT NULL COMMENT 'æˆå°±æè¿°',
  `icon` VARCHAR(32) NOT NULL COMMENT 'å›¾æ ‡',
  `condition_type` VARCHAR(32) NOT NULL COMMENT 'è¾¾æˆæ¡ä»¶ç±»å‹',
  `condition_value` INT NOT NULL COMMENT 'è¾¾æˆæ¡ä»¶å€¼',
  `reward_points` INT DEFAULT 0 COMMENT 'å¥–åŠ±ç§¯åˆ†',
  `sort_order` INT DEFAULT 0 COMMENT 'æ’åº',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æˆå°±å®šä¹‰è¡¨';

-- åˆå§‹æ•°æ®
INSERT INTO `achievements` (`id`, `name`, `description`, `icon`, `condition_type`, `condition_value`, `reward_points`, `sort_order`) VALUES
('first_dream', 'åˆæ¬¡è®°æ¢¦', 'è®°å½•ç¬¬ä¸€ä¸ªæ¢¦å¢ƒ', 'ğŸŒ™', 'total_dreams', 1, 10, 1),
('dreams_10', 'å…¥é—¨æ¢¦æƒ³å®¶', 'ç´¯è®¡è®°å½•10ä¸ªæ¢¦å¢ƒ', 'âœ¨', 'total_dreams', 10, 20, 2),
('dreams_50', 'èµ„æ·±æ¢¦æƒ³å®¶', 'ç´¯è®¡è®°å½•50ä¸ªæ¢¦å¢ƒ', 'ğŸŒŸ', 'total_dreams', 50, 50, 3),
('dreams_100', 'æ¢¦å¢ƒå¤§å¸ˆ', 'ç´¯è®¡è®°å½•100ä¸ªæ¢¦å¢ƒ', 'ğŸ‘‘', 'total_dreams', 100, 100, 4),
('streak_3', 'ä¸‰æ—¥è¿ç»­', 'è¿ç»­è®°æ¢¦3å¤©', 'ğŸ”¥', 'consecutive_days', 3, 15, 5),
('streak_7', 'å‘¨å‘¨æœ‰æ¢¦', 'è¿ç»­è®°æ¢¦7å¤©', 'ğŸ”¥ğŸ”¥', 'consecutive_days', 7, 30, 6),
('streak_30', 'æœˆåº¦åšæŒ', 'è¿ç»­è®°æ¢¦30å¤©', 'ğŸ”¥ğŸ”¥ğŸ”¥', 'consecutive_days', 30, 100, 7),
('tasks_10', 'ä»»åŠ¡æ–°æ‰‹', 'å®Œæˆ10ä¸ªæ”¹è¿ä»»åŠ¡', 'ğŸ¯', 'total_tasks', 10, 20, 8),
('tasks_50', 'ä»»åŠ¡è¾¾äºº', 'å®Œæˆ50ä¸ªæ”¹è¿ä»»åŠ¡', 'ğŸ†', 'total_tasks', 50, 50, 9);
```

## 3. MongoDB é›†åˆè®¾è®¡

### 3.1 æ¢¦å¢ƒé›†åˆ (dreams)

```javascript
// é›†åˆ: dreams
{
  _id: ObjectId("..."),                    // MongoDB ID
  dreamId: "dream_789",                    // ä¸šåŠ¡ID
  userId: "user_123456",                   // ç”¨æˆ·ID
  content: "æˆ‘æ¢¦è§è‡ªå·±åœ¨ä¸€ç‰‡è‰åœ°ä¸Šå¥”è·‘...",   // æ¢¦å¢ƒå†…å®¹
  tags: ["flying", "nature"],              // æ ‡ç­¾
  emotion: "happy",                        // æƒ…ç»ª
  wordCount: 150,                          // å­—æ•°
  status: "analyzed",                      // çŠ¶æ€: pending/analyzed/deleted
  analysisId: "analysis_123",              // å…³è”è§£æID

  // å…ƒæ•°æ®
  meta: {
    platform: "mp-weixin",                 // æ¥æºå¹³å°
    version: "1.0.0",                      // å®¢æˆ·ç«¯ç‰ˆæœ¬
    deviceInfo: {                          // è®¾å¤‡ä¿¡æ¯
      brand: "iPhone",
      model: "iPhone 14",
      system: "iOS 16.0"
    }
  },

  createdAt: ISODate("2026-01-21T08:00:00Z"),
  updatedAt: ISODate("2026-01-21T08:05:00Z"),
  deletedAt: null
}

// ç´¢å¼•
db.dreams.createIndex({ dreamId: 1 }, { unique: true })
db.dreams.createIndex({ userId: 1, createdAt: -1 })
db.dreams.createIndex({ userId: 1, status: 1 })
db.dreams.createIndex({ createdAt: -1 })
db.dreams.createIndex({ content: "text" })  // å…¨æ–‡ç´¢å¼•
```

### 3.2 è§£æç»“æœé›†åˆ (analyses)

```javascript
// é›†åˆ: analyses
{
  _id: ObjectId("..."),
  analysisId: "analysis_123",               // ä¸šåŠ¡ID
  dreamId: "dream_789",                     // å…³è”æ¢¦å¢ƒID
  userId: "user_123456",                    // ç”¨æˆ·ID

  // è§£æå†…å®¹
  theme: "å¯¹è‡ªç”±çš„æ¸´æœ›ä¸å‘å¾€",                // ä¸»é¢˜
  interpretation: "è¿™ä¸ªæ¢¦å¢ƒåæ˜ äº†ä½ å†…å¿ƒå¯¹è‡ªç”±çš„æ¸´æœ›ã€‚è‰åœ°è±¡å¾ç€å¹¿é˜”çš„å¯èƒ½æ€§...",

  // è¿åŠ¿
  fortune: {
    score: 85,                              // è¿åŠ¿è¯„åˆ†
    tips: {
      career: "é€‚åˆå°è¯•æ–°äº‹ç‰©ï¼ŒæŠŠæ¡æœºä¼šä¸»åŠ¨å‡ºå‡»",
      love: "ä¿æŒå¼€æ”¾å¿ƒæ€ï¼Œå¯èƒ½æœ‰æ„å¤–æƒŠå–œ",
      health: "ç²¾åŠ›å……æ²›ï¼Œå¤šåšæˆ·å¤–è¿åŠ¨"
    }
  },

  // AIç›¸å…³
  ai: {
    model: "qwen-turbo",                    // ä½¿ç”¨çš„æ¨¡å‹
    promptVersion: "v1.2",                  // Promptç‰ˆæœ¬
    tokensUsed: 1500,                       // Tokenæ¶ˆè€—
    latency: 3200,                          // å“åº”æ—¶é—´(ms)
    rawResponse: "...",                     // åŸå§‹å“åº”(å¯é€‰ä¿ç•™)
  },

  // ä»»åŠ¡
  task: {
    taskId: "task_456",
    type: "action",
    content: "ä»Šå¤©å‡ºé—¨æ—¶æ·±å‘¼å¸ä¸‰æ¬¡ï¼Œæ„Ÿå—è‡ªç”±çš„ç©ºæ°”"
  },

  disclaimer: "æœ¬è§£æä»…ä¾›å¨±ä¹å‚è€ƒï¼Œä¸æ„æˆä»»ä½•ä¸“ä¸šå»ºè®®",

  status: "completed",                      // processing/completed/failed
  createdAt: ISODate("2026-01-21T08:05:00Z"),
  updatedAt: ISODate("2026-01-21T08:05:00Z")
}

// ç´¢å¼•
db.analyses.createIndex({ analysisId: 1 }, { unique: true })
db.analyses.createIndex({ dreamId: 1 })
db.analyses.createIndex({ userId: 1, createdAt: -1 })
```

### 3.3 æ“ä½œæ—¥å¿—é›†åˆ (operation_logs)

```javascript
// é›†åˆ: operation_logs
{
  _id: ObjectId("..."),
  userId: "user_123456",
  action: "dream_submit",                   // æ“ä½œç±»å‹
  target: {
    type: "dream",
    id: "dream_789"
  },
  params: {                                 // è¯·æ±‚å‚æ•°(è„±æ•)
    wordCount: 150,
    tagsCount: 2
  },
  result: {
    success: true,
    code: 0
  },
  meta: {
    ip: "xxx.xxx.xxx.xxx",
    userAgent: "...",
    platform: "mp-weixin",
    requestId: "req_xxx"
  },
  createdAt: ISODate("2026-01-21T08:00:00Z")
}

// ç´¢å¼•
db.operation_logs.createIndex({ userId: 1, createdAt: -1 })
db.operation_logs.createIndex({ action: 1, createdAt: -1 })
db.operation_logs.createIndex({ createdAt: 1 }, { expireAfterSeconds: 7776000 })  // 90å¤©è‡ªåŠ¨åˆ é™¤
```

## 4. Redis æ•°æ®ç»“æ„

### 4.1 Key å‘½åè§„èŒƒ

```
{ä¸šåŠ¡åŸŸ}:{æ•°æ®ç±»å‹}:{æ ‡è¯†ç¬¦}:{å­é¡¹}

ä¾‹å¦‚:
user:info:user_123456           # ç”¨æˆ·ä¿¡æ¯
dream:list:user_123456          # æ¢¦å¢ƒåˆ—è¡¨
rate:dream_submit:user_123456   # æ¢¦å¢ƒæäº¤é™æµ
session:token_xxx               # ä¼šè¯ä¿¡æ¯
```

### 4.2 å¸¸ç”¨æ•°æ®ç»“æ„

```redis
# 1. ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ (String + JSON)
SET user:info:user_123456 '{"id":"user_123456","nickname":"...","isVip":false,...}'
EXPIRE user:info:user_123456 86400  # 24å°æ—¶

# 2. ç”¨æˆ·Token (String)
SET session:token_xxx "user_123456"
EXPIRE session:token_xxx 7200  # 2å°æ—¶

# 3. ä»Šæ—¥æ¢¦å¢ƒæ ‡è®° (String)
SET dream:today:user_123456:2026-01-21 "dream_789"
EXPIREAT dream:today:user_123456:2026-01-21 <å½“æ—¥24ç‚¹æ—¶é—´æˆ³>

# 4. è¿ç»­è®°æ¢¦è®¡æ•° (Hash)
HSET user:streak:user_123456 consecutive_days 7
HSET user:streak:user_123456 last_date "2026-01-20"

# 5. ç”¨æˆ·æ¢¦å¢ƒæ—¥å† (BitMap)
SETBIT dream:calendar:user_123456:2026-01 20 1   # 1æœˆ20æ—¥æœ‰è®°æ¢¦
SETBIT dream:calendar:user_123456:2026-01 21 1   # 1æœˆ21æ—¥æœ‰è®°æ¢¦

# 6. é™æµè®¡æ•° (String + INCR)
SET rate:dream_submit:user_123456 1
EXPIRE rate:dream_submit:user_123456 86400  # æ¯æ—¥é‡ç½®

# 7. æ’è¡Œæ¦œ (Sorted Set)
ZADD leaderboard:streak 7 user_123456
ZADD leaderboard:streak 14 user_234567

# 8. é…ç½®ç¼“å­˜ (Hash)
HSET config:app dream_tags '[...]'
HSET config:app emotions '[...]'

# 9. å¹¿å‘ŠToken (String)
SET ad:token:ad_token_xxx '{"userId":"user_123456","position":"before_analysis"}'
EXPIRE ad:token:ad_token_xxx 300  # 5åˆ†é’Ÿæœ‰æ•ˆ
```

## 5. æ•°æ®è¿ç§»ä¸å¤‡ä»½

### 5.1 å¤‡ä»½ç­–ç•¥

| æ•°æ®åº“ | å¤‡ä»½æ–¹å¼ | é¢‘ç‡ | ä¿ç•™æ—¶é—´ |
|--------|----------|------|----------|
| MySQL | å…¨é‡å¤‡ä»½ | æ¯æ—¥å‡Œæ™¨ | 30å¤© |
| MySQL | binlogåŒæ­¥ | å®æ—¶ | 7å¤© |
| MongoDB | å‰¯æœ¬é›† | å®æ—¶ | - |
| MongoDB | å¿«ç…§å¤‡ä»½ | æ¯æ—¥ | 7å¤© |
| Redis | RDB | æ¯å°æ—¶ | 24å°æ—¶ |
| Redis | AOF | å®æ—¶ | 24å°æ—¶ |

### 5.2 æ•°æ®å½’æ¡£

```sql
-- å†å²æ•°æ®å½’æ¡£ï¼ˆè¶…è¿‡1å¹´çš„æ•°æ®ï¼‰
-- æ¯æœˆæ‰§è¡Œä¸€æ¬¡ï¼Œå°†æ—§æ•°æ®è¿ç§»åˆ°å½’æ¡£è¡¨

-- æ¢¦å¢ƒæ•°æ®å½’æ¡£
INSERT INTO dreams_archive SELECT * FROM dreams
WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);

DELETE FROM dreams
WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

## 6. ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users     â”‚       â”‚    dreams    â”‚       â”‚  analyses    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)      â”‚â”€â”€â”€â”€â”€â”€<â”‚ user_id (FK) â”‚       â”‚ analysis_id  â”‚
â”‚ open_id      â”‚       â”‚ dream_id     â”‚â”€â”€â”€â”€â”€â”€<â”‚ dream_id (FK)â”‚
â”‚ nickname     â”‚       â”‚ content      â”‚       â”‚ user_id (FK) â”‚
â”‚ is_vip       â”‚       â”‚ tags         â”‚       â”‚ theme        â”‚
â”‚ lucky_points â”‚       â”‚ emotion      â”‚       â”‚ interpretationâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ status       â”‚       â”‚ fortune      â”‚
        â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                      â”‚
        â”‚                     â”‚                      â”‚
        â–¼                     â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚point_records â”‚       â”‚    tasks     â”‚       â”‚  ad_records  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_id (FK) â”‚       â”‚ user_id (FK) â”‚       â”‚ user_id (FK) â”‚
â”‚ type         â”‚       â”‚ dream_id (FK)â”‚       â”‚ ad_type      â”‚
â”‚ amount       â”‚       â”‚ content      â”‚       â”‚ event_type   â”‚
â”‚ source       â”‚       â”‚ status       â”‚       â”‚ token        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   orders     â”‚       â”‚  vip_plans   â”‚       â”‚   configs    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_id (FK) â”‚       â”‚ id (PK)      â”‚       â”‚ key          â”‚
â”‚ product_id   â”‚â”€â”€â”€â”€â”€â”€>â”‚ name         â”‚       â”‚ value        â”‚
â”‚ amount       â”‚       â”‚ price        â”‚       â”‚ description  â”‚
â”‚ status       â”‚       â”‚ duration_daysâ”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. Prisma Schema

```prisma
// prisma/schema.prisma

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String    @id @default(cuid())
  openId          String    @unique @map("open_id")
  unionId         String?   @map("union_id")
  nickname        String    @default("æ¢¦æ¸¸è€…")
  avatar          String?
  gender          Int       @default(0)
  phone           String?
  isVip           Boolean   @default(false) @map("is_vip")
  vipExpireAt     DateTime? @map("vip_expire_at")
  luckyPoints     Int       @default(0) @map("lucky_points")
  consecutiveDays Int       @default(0) @map("consecutive_days")
  lastDreamDate   DateTime? @map("last_dream_date") @db.Date
  totalDreams     Int       @default(0) @map("total_dreams")
  totalTasks      Int       @default(0) @map("total_tasks")
  status          Int       @default(1)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  tasks         Task[]
  orders        Order[]
  pointRecords  PointRecord[]
  adRecords     AdRecord[]
  achievements  UserAchievement[]

  @@map("users")
}

model Task {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  dreamId        String    @map("dream_id")
  analysisId     String    @map("analysis_id")
  type           String
  content        String
  rewardPoints   Int       @default(10) @map("reward_points")
  status         TaskStatus @default(pending)
  isDoubleReward Boolean   @default(false) @map("is_double_reward")
  completedAt    DateTime? @map("completed_at")
  expireAt       DateTime  @map("expire_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([dreamId])
  @@index([status, expireAt])
  @@map("tasks")
}

model PointRecord {
  id          BigInt   @id @default(autoincrement())
  userId      String   @map("user_id")
  type        PointType
  amount      Int
  balance     Int
  source      String
  sourceId    String?  @map("source_id")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("point_records")
}

model Order {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  orderNo       String      @unique @map("order_no")
  type          OrderType
  productId     String      @map("product_id")
  productName   String      @map("product_name")
  amount        Decimal     @db.Decimal(10, 2)
  payAmount     Decimal     @map("pay_amount") @db.Decimal(10, 2)
  status        OrderStatus @default(pending)
  payType       String?     @map("pay_type")
  transactionId String?     @map("transaction_id")
  paidAt        DateTime?   @map("paid_at")
  expireAt      DateTime    @map("expire_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model VipPlan {
  id           String   @id
  name         String
  durationDays Int      @map("duration_days")
  price        Decimal  @db.Decimal(10, 2)
  originalPrice Decimal @map("original_price") @db.Decimal(10, 2)
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("vip_plans")
}

model AdRecord {
  id        BigInt   @id @default(autoincrement())
  userId    String   @map("user_id")
  adType    String   @map("ad_type")
  position  String
  eventType String   @map("event_type")
  duration  Int?
  errorMsg  String?  @map("error_msg")
  token     String?
  tokenUsed Boolean  @default(false) @map("token_used")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@map("ad_records")
}

model Achievement {
  id             String  @id
  name           String
  description    String
  icon           String
  conditionType  String  @map("condition_type")
  conditionValue Int     @map("condition_value")
  rewardPoints   Int     @default(0) @map("reward_points")
  sortOrder      Int     @default(0) @map("sort_order")
  isActive       Boolean @default(true) @map("is_active")

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")

  user        User        @relation(fields: [userId], references: [id])
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Config {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("configs")
}

enum TaskStatus {
  pending
  completed
  expired
}

enum PointType {
  earn
  consume
}

enum OrderType {
  vip
}

enum OrderStatus {
  pending
  paid
  cancelled
  refunded
}
```
