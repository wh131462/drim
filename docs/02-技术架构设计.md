# 梦见小程序 - 技术架构设计

## 1. 技术选型

### 1.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| uni-app | 3.0+ | 跨平台框架 |
| Vue 3 | 3.4+ | 前端框架 |
| TypeScript | 4.9+ | 类型系统 |
| Pinia | 2.x | 状态管理 |
| uni-ui | latest | UI组件库 |
| Vite | 5.x | 构建工具 |

### 1.2 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 18+ | 运行环境 |
| NestJS | 10.x | 后端框架 |
| TypeScript | 5.x | 类型系统 |
| Prisma | 5.x | ORM |
| Redis | 7.x | 缓存 |
| MySQL | 8.x | 关系型数据库 |
| MongoDB | 6.x | 文档数据库 |

### 1.3 第三方服务

| 服务 | 提供商 | 用途 |
|------|--------|------|
| AI大模型 | 通义千问/文心一言 | 梦境解析 |
| 微信开放平台 | 腾讯 | 登录、支付、广告 |
| 对象存储 | 阿里云OSS | 静态资源 |
| CDN | 阿里云CDN | 加速 |

## 2. 前端架构

### 2.1 目录结构

```
src/
├── api/                    # API 接口定义
│   ├── modules/            # 按模块划分
│   │   ├── user.ts         # 用户相关接口
│   │   ├── dream.ts        # 梦境相关接口
│   │   ├── analysis.ts     # 解析相关接口
│   │   ├── task.ts         # 任务相关接口
│   │   └── ad.ts           # 广告相关接口
│   ├── request.ts          # 请求封装
│   └── index.ts            # 统一导出
│
├── components/             # 公共组件
│   ├── base/               # 基础组件
│   │   ├── DButton.vue     # 按钮
│   │   ├── DInput.vue      # 输入框
│   │   ├── DModal.vue      # 弹窗
│   │   └── DLoading.vue    # 加载
│   ├── business/           # 业务组件
│   │   ├── DreamCard.vue   # 梦境卡片
│   │   ├── TagSelector.vue # 标签选择器
│   │   ├── EmotionPicker.vue # 情绪选择
│   │   ├── CalendarView.vue  # 日历视图
│   │   └── AnalysisCard.vue  # 解析卡片
│   └── layout/             # 布局组件
│       ├── NavBar.vue      # 导航栏
│       └── TabBar.vue      # 底部栏
│
├── composables/            # 组合式函数
│   ├── useUser.ts          # 用户相关
│   ├── useDream.ts         # 梦境相关
│   ├── useAd.ts            # 广告相关
│   ├── useAuth.ts          # 认证相关
│   └── useStorage.ts       # 存储相关
│
├── pages/                  # 页面
│   ├── index/              # 首页
│   │   └── index.vue
│   ├── record/             # 记录梦境
│   │   └── index.vue
│   ├── result/             # 解析结果
│   │   └── index.vue
│   ├── profile/            # 我的
│   │   └── index.vue
│   ├── dream-detail/       # 梦境详情
│   │   └── index.vue
│   ├── vip/                # 会员
│   │   └── index.vue
│   └── settings/           # 设置
│       └── index.vue
│
├── stores/                 # Pinia 状态管理
│   ├── modules/
│   │   ├── user.ts         # 用户状态
│   │   ├── dream.ts        # 梦境状态
│   │   ├── task.ts         # 任务状态
│   │   └── config.ts       # 配置状态
│   └── index.ts
│
├── types/                  # TypeScript 类型定义
│   ├── user.d.ts
│   ├── dream.d.ts
│   ├── analysis.d.ts
│   ├── task.d.ts
│   └── api.d.ts
│
├── utils/                  # 工具函数
│   ├── date.ts             # 日期处理
│   ├── format.ts           # 格式化
│   ├── validate.ts         # 校验
│   ├── storage.ts          # 本地存储
│   └── report.ts           # 埋点上报
│
├── constants/              # 常量定义
│   ├── tags.ts             # 梦境标签
│   ├── emotions.ts         # 情绪类型
│   └── config.ts           # 配置常量
│
├── styles/                 # 样式文件
│   ├── variables.scss      # 变量定义
│   ├── mixins.scss         # 混入
│   └── common.scss         # 公共样式
│
├── static/                 # 静态资源
│   ├── images/
│   └── icons/
│
├── App.vue
├── main.ts
├── pages.json              # 页面配置
├── manifest.json           # 应用配置
└── uni.scss                # uni-app样式变量
```

### 2.2 请求封装

```typescript
// src/api/request.ts
import { useUserStore } from '@/stores/modules/user'

interface RequestConfig extends UniApp.RequestOptions {
  showLoading?: boolean
  showError?: boolean
}

interface ApiResponse<T = any> {
  code: number
  data: T
  message: string
}

const BASE_URL = import.meta.env.VITE_API_BASE_URL

export const request = <T>(config: RequestConfig): Promise<T> => {
  const userStore = useUserStore()

  return new Promise((resolve, reject) => {
    if (config.showLoading !== false) {
      uni.showLoading({ title: '加载中...' })
    }

    uni.request({
      ...config,
      url: `${BASE_URL}${config.url}`,
      header: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${userStore.token}`,
        ...config.header
      },
      success: (res) => {
        const data = res.data as ApiResponse<T>
        if (data.code === 0) {
          resolve(data.data)
        } else if (data.code === 401) {
          // Token 过期，重新登录
          userStore.logout()
          uni.reLaunch({ url: '/pages/index/index' })
          reject(new Error('登录已过期'))
        } else {
          if (config.showError !== false) {
            uni.showToast({ title: data.message, icon: 'none' })
          }
          reject(new Error(data.message))
        }
      },
      fail: (err) => {
        if (config.showError !== false) {
          uni.showToast({ title: '网络错误', icon: 'none' })
        }
        reject(err)
      },
      complete: () => {
        if (config.showLoading !== false) {
          uni.hideLoading()
        }
      }
    })
  })
}
```

### 2.3 状态管理设计

```typescript
// src/stores/modules/user.ts
import { defineStore } from 'pinia'
import { userApi } from '@/api'

interface UserInfo {
  id: string
  openId: string
  nickname: string
  avatar: string
  isVip: boolean
  vipExpireAt: string | null
  luckyPoints: number
  consecutiveDays: number
}

interface UserState {
  token: string
  userInfo: UserInfo | null
  isLoggedIn: boolean
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    token: uni.getStorageSync('token') || '',
    userInfo: null,
    isLoggedIn: false
  }),

  getters: {
    isVip: (state) => state.userInfo?.isVip ?? false,
    luckyPoints: (state) => state.userInfo?.luckyPoints ?? 0
  },

  actions: {
    async login() {
      try {
        const { code } = await uni.login({ provider: 'weixin' })
        const { token, userInfo } = await userApi.login({ code })
        this.token = token
        this.userInfo = userInfo
        this.isLoggedIn = true
        uni.setStorageSync('token', token)
      } catch (error) {
        console.error('登录失败', error)
        throw error
      }
    },

    async fetchUserInfo() {
      if (!this.token) return
      try {
        this.userInfo = await userApi.getUserInfo()
        this.isLoggedIn = true
      } catch (error) {
        this.logout()
      }
    },

    logout() {
      this.token = ''
      this.userInfo = null
      this.isLoggedIn = false
      uni.removeStorageSync('token')
    },

    updateLuckyPoints(points: number) {
      if (this.userInfo) {
        this.userInfo.luckyPoints = points
      }
    }
  }
})
```

### 2.4 组合式函数示例

```typescript
// src/composables/useDream.ts
import { ref, computed } from 'vue'
import { dreamApi } from '@/api'
import type { Dream, DreamInput } from '@/types/dream'

export function useDream() {
  const loading = ref(false)
  const currentDream = ref<Dream | null>(null)
  const dreamList = ref<Dream[]>([])

  const todayDream = computed(() => {
    const today = new Date().toDateString()
    return dreamList.value.find(
      d => new Date(d.createdAt).toDateString() === today
    )
  })

  const hasTodayDream = computed(() => !!todayDream.value)

  async function submitDream(input: DreamInput) {
    loading.value = true
    try {
      const dream = await dreamApi.create(input)
      currentDream.value = dream
      dreamList.value.unshift(dream)
      return dream
    } finally {
      loading.value = false
    }
  }

  async function fetchDreamList(page = 1, pageSize = 20) {
    loading.value = true
    try {
      const { list, total } = await dreamApi.getList({ page, pageSize })
      if (page === 1) {
        dreamList.value = list
      } else {
        dreamList.value.push(...list)
      }
      return { list, total }
    } finally {
      loading.value = false
    }
  }

  async function getDreamById(id: string) {
    loading.value = true
    try {
      return await dreamApi.getById(id)
    } finally {
      loading.value = false
    }
  }

  return {
    loading,
    currentDream,
    dreamList,
    todayDream,
    hasTodayDream,
    submitDream,
    fetchDreamList,
    getDreamById
  }
}
```

## 3. 后端架构

### 3.1 目录结构

```
server/
├── src/
│   ├── common/              # 公共模块
│   │   ├── decorators/      # 自定义装饰器
│   │   ├── filters/         # 异常过滤器
│   │   ├── guards/          # 守卫
│   │   ├── interceptors/    # 拦截器
│   │   └── pipes/           # 管道
│   │
│   ├── config/              # 配置
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── ai.config.ts
│   │
│   ├── modules/             # 业务模块
│   │   ├── user/
│   │   │   ├── user.controller.ts
│   │   │   ├── user.service.ts
│   │   │   ├── user.module.ts
│   │   │   └── dto/
│   │   │
│   │   ├── dream/
│   │   │   ├── dream.controller.ts
│   │   │   ├── dream.service.ts
│   │   │   ├── dream.module.ts
│   │   │   └── dto/
│   │   │
│   │   ├── analysis/
│   │   │   ├── analysis.controller.ts
│   │   │   ├── analysis.service.ts
│   │   │   ├── analysis.module.ts
│   │   │   ├── prompt.service.ts    # Prompt 管理
│   │   │   └── dto/
│   │   │
│   │   ├── task/
│   │   │   ├── task.controller.ts
│   │   │   ├── task.service.ts
│   │   │   └── task.module.ts
│   │   │
│   │   ├── points/
│   │   │   ├── points.controller.ts
│   │   │   ├── points.service.ts
│   │   │   └── points.module.ts
│   │   │
│   │   └── ad/
│   │       ├── ad.controller.ts
│   │       ├── ad.service.ts
│   │       └── ad.module.ts
│   │
│   ├── shared/              # 共享服务
│   │   ├── ai/              # AI服务封装
│   │   ├── cache/           # 缓存服务
│   │   ├── logger/          # 日志服务
│   │   └── wechat/          # 微信SDK封装
│   │
│   ├── prisma/              # Prisma 相关
│   │   ├── schema.prisma
│   │   └── migrations/
│   │
│   ├── app.module.ts
│   └── main.ts
│
├── test/                    # 测试
├── .env                     # 环境变量
├── .env.production
├── nest-cli.json
├── package.json
└── tsconfig.json
```

### 3.2 AI 解析服务设计

```typescript
// src/modules/analysis/analysis.service.ts
import { Injectable } from '@nestjs/common'
import { AIService } from '@/shared/ai/ai.service'
import { PromptService } from './prompt.service'
import { PrismaService } from '@/prisma/prisma.service'
import type { Dream, Analysis } from '@prisma/client'

@Injectable()
export class AnalysisService {
  constructor(
    private readonly aiService: AIService,
    private readonly promptService: PromptService,
    private readonly prisma: PrismaService
  ) {}

  async analyze(dream: Dream, userId: string): Promise<Analysis> {
    // 1. 构建 Prompt
    const prompt = this.promptService.buildAnalysisPrompt({
      content: dream.content,
      tags: dream.tags,
      emotion: dream.emotion
    })

    // 2. 调用 AI 接口
    const aiResponse = await this.aiService.chat(prompt)

    // 3. 解析 AI 响应
    const parsed = this.parseAIResponse(aiResponse)

    // 4. 生成改运任务
    const task = this.generateTask(parsed)

    // 5. 保存解析结果
    const analysis = await this.prisma.analysis.create({
      data: {
        dreamId: dream.id,
        userId,
        theme: parsed.theme,
        interpretation: parsed.interpretation,
        fortuneScore: parsed.fortuneScore,
        fortuneTips: parsed.fortuneTips,
        taskId: task.id
      }
    })

    return analysis
  }

  private parseAIResponse(response: string): ParsedAnalysis {
    // 解析 AI 返回的结构化数据
    try {
      return JSON.parse(response)
    } catch {
      // 降级处理：使用正则提取关键信息
      return this.fallbackParse(response)
    }
  }

  private generateTask(analysis: ParsedAnalysis): Task {
    // 基于解析结果生成改运任务
    const taskTemplates = [
      { type: 'wear', content: '今天戴{color}色饰品' },
      { type: 'food', content: '今天喝咖啡时加{topping}' },
      { type: 'action', content: '今天{action}' }
    ]
    // ...任务生成逻辑
  }
}
```

### 3.3 Prompt 设计

```typescript
// src/modules/analysis/prompt.service.ts
import { Injectable } from '@nestjs/common'

interface PromptInput {
  content: string
  tags: string[]
  emotion: string
}

@Injectable()
export class PromptService {
  buildAnalysisPrompt(input: PromptInput): string {
    return `
你是一位专业的梦境解析师，精通心理学和中国传统解梦文化。请根据用户的梦境进行分析。

## 用户梦境
内容：${input.content}
标签：${input.tags.join('、')}
情绪：${input.emotion}

## 输出要求
请以JSON格式返回分析结果，包含以下字段：

{
  "theme": "一句话概括梦境主题（不超过15字）",
  "interpretation": "心理解读（3-5句话，需要专业但易懂）",
  "fortuneScore": 数字(1-100的运势评分),
  "fortuneTips": {
    "career": "事业运势提示",
    "love": "感情运势提示",
    "health": "健康运势提示"
  },
  "task": {
    "type": "任务类型(wear/food/action)",
    "content": "具体任务内容"
  }
}

## 注意事项
1. 解读内容需要积极正面，避免负面预测
2. 运势评分不要低于50分
3. 任务要简单有趣，容易完成
4. 避免使用"算命""预测未来"等敏感词
5. 在解读末尾添加免责提示

请直接返回JSON，不要有其他内容。
`
  }
}
```

## 4. 数据流架构

### 4.1 请求流程

```
┌──────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 前端 │────▶│   网关   │────▶│  服务层  │────▶│  数据层  │
└──────┘     └──────────┘     └──────────┘     └──────────┘
    │             │                 │                │
    │             │                 │                │
    │        1.鉴权校验        2.业务处理       3.数据操作
    │        限流控制          AI调用          读写DB
    │        日志记录          缓存处理        缓存更新
    │             │                 │                │
    ▼             ▼                 ▼                ▼
┌─────────────────────────────────────────────────────────┐
│                     响应返回                            │
└─────────────────────────────────────────────────────────┘
```

### 4.2 AI 解析流程

```
┌───────────────┐
│ 用户提交梦境   │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 敏感词检测    │──违规──▶ 拒绝并提示
└───────┬───────┘
        │通过
        ▼
┌───────────────┐
│  保存梦境记录  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│ 构建AI Prompt │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  调用AI API   │──失败──▶ 使用兜底模板
└───────┬───────┘
        │成功
        ▼
┌───────────────┐
│  解析AI响应   │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  生成改运任务  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  保存解析结果  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  返回前端展示  │
└───────────────┘
```

## 5. 缓存策略

### 5.1 缓存层级

| 层级 | 存储位置 | 缓存内容 | 过期策略 |
|------|----------|----------|----------|
| L1 | 前端内存 | 页面数据 | 页面销毁清除 |
| L2 | 本地存储 | 用户信息、配置 | 手动更新 |
| L3 | Redis | 热点数据、会话 | TTL过期 |
| L4 | 数据库 | 持久化数据 | 不过期 |

### 5.2 缓存 Key 设计

```
# 用户信息
user:{userId}:info
user:{userId}:points
user:{userId}:consecutive_days

# 梦境相关
dream:{dreamId}:detail
dream:user:{userId}:list
dream:user:{userId}:calendar:{month}

# 解析结果
analysis:{dreamId}:result
analysis:user:{userId}:today

# 配置数据
config:tags
config:emotions
config:task_templates

# 限流
rate_limit:user:{userId}:dream_submit
rate_limit:ip:{ip}:api_call
```

## 6. 安全设计

### 6.1 接口安全

- JWT Token 认证
- 接口签名验证
- 请求频率限制
- SQL 注入防护
- XSS 过滤

### 6.2 数据安全

- 敏感数据加密存储
- 传输层 HTTPS
- 用户隐私数据脱敏
- 日志脱敏处理

### 6.3 内容安全

- 敏感词过滤
- AI 输出审核
- 用户举报机制
- 内容追溯能力

## 7. 监控告警

### 7.1 监控指标

| 类型 | 指标 | 阈值 |
|------|------|------|
| 接口 | 响应时间 P99 | < 1s |
| 接口 | 错误率 | < 1% |
| AI | 调用成功率 | > 95% |
| AI | 平均响应时间 | < 5s |
| 系统 | CPU 使用率 | < 80% |
| 系统 | 内存使用率 | < 80% |

### 7.2 告警规则

- 接口错误率 > 5% 持续 5 分钟
- AI 服务不可用
- 数据库连接异常
- Redis 连接异常
- 磁盘使用率 > 90%
