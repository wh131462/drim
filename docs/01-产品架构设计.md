# 梦见小程序 - 产品架构设计

## 1. 系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  微信小程序  │  │   H5 端     │  │  其他平台   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        网关层 (API Gateway)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   认证鉴权   │  │   限流控制   │  │   日志记录   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务服务层                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 用户服务  │ │ 梦境服务  │ │ 解析服务  │ │ 任务服务  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ 积分服务  │ │ 广告服务  │ │ 会员服务  │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  MySQL   │  │ MongoDB  │  │  Redis   │  │   OSS    │        │
│  │ 用户/配置 │  │ 梦境文本  │  │   缓存   │  │ 静态资源  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        第三方服务                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 微信开放  │  │ AI大模型  │  │ 广告平台  │  │ 消息推送  │        │
│  │  平台    │  │   API    │  │   SDK   │  │   服务   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 功能模块划分

### 2.1 模块关系图

```
                    ┌──────────────┐
                    │    首页      │
                    │  (入口模块)   │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┬───────────────┐
           │               │               │               │
           ▼               ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │ 梦境记录  │    │ 梦境日历  │    │ 探索模块  │    │ 个人中心  │
    │  模块    │    │   模块   │    │ (新增)   │    │   模块   │
    └────┬─────┘    └──────────┘    └──────────┘    └────┬─────┘
         │                                               │
         ▼                                               ▼
    ┌──────────┐                                   ┌──────────┐
    │ AI解析   │                                   │ 会员系统  │
    │  模块    │                                   │   模块   │
    └────┬─────┘                                   └──────────┘
         │
         ├─────────────────┐
         │                 │
         ▼                 ▼
    ┌──────────┐    ┌──────────┐
    │ AI润色   │    │ 改运任务  │
    │模块(新增) │    │  模块    │
    └──────────┘    └────┬─────┘
                         │
                         ▼
                    ┌──────────┐
                    │ 积分系统  │
                    │  模块    │
                    └──────────┘
```

### 2.2 核心模块说明

| 模块           | 职责                                           | 依赖模块                 |
| -------------- | ---------------------------------------------- | ------------------------ |
| 用户模块       | 登录、注册、用户信息管理                       | 微信登录                 |
| 梦境记录模块   | 梦境输入、标签选择、情绪标记、隐私设置         | 用户模块                 |
| AI解析模块     | 调用大模型生成解析结果                         | 梦境模块、广告模块       |
| **AI润色模块** | **基于原始梦境生成更有故事性的版本、版本管理** | **梦境模块、AI解析模块** |
| **探索模块**   | **发现公开梦境、浏览他人梦境、互动**           | **梦境模块、用户模块**   |
| 梦境日历模块   | 历史记录展示、连续打卡统计                     | 梦境模块                 |
| 改运任务模块   | 任务展示、完成打卡                             | 解析模块、积分模块       |
| 积分系统模块   | 积分获取、消耗、记录                           | 任务模块、权益模块       |
| 广告模块       | 激励视频、Banner广告                           | 微信广告SDK              |
| 权益模块       | 权益兑换、特权管理（积分兑换，无付费）         | 积分模块                 |

## 3. 用户流程设计

### 3.1 核心用户旅程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  打开   │───▶│  记录   │───▶│ AI润色  │───▶│  观看   │───▶│  查看   │
│ 小程序  │    │  梦境   │    │ (可选)  │    │  广告   │    │  解析   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │                              │
     │              │              ▼                              │
     │              │         ┌─────────┐                         │
     │              │         │版本切换 │                         │
     │              │         │继续编辑 │                         │
     │              │         └─────────┘                         │
     │              │                                             │
     │              ▼                                             ▼
     │         ┌─────────┐                                  ┌─────────┐
     │         │设置隐私 │                                  │  完成   │
     │         │公开/私密│                                  │  任务   │
     │         └─────────┘                                  └─────────┘
     │                                                           │
     │                                                           ▼
     │                                                      ┌─────────┐
     │                                                      │  获得   │
     │                                                      │  积分   │
     │                                                      └─────────┘
     │
     ├──────────────────────┐
     │                      │
     ▼                      ▼
┌─────────┐           ┌─────────┐    ┌─────────┐
│  探索   │           │  查看   │───▶│  历史   │
│公开梦境 │           │  日历   │    │  回顾   │
└─────────┘           └─────────┘    └─────────┘
     │
     ▼
┌─────────┐
│  浏览   │
│他人梦境 │
└─────────┘
```

### 3.2 状态流转

```
梦境状态:
[草稿] ──提交──▶ [待解析] ──解析中──▶ [已解析] ──删除──▶ [已删除]
   │                                      │
   └──AI润色──▶ [润色版本]                │
        │           │                     │
        │           └──切换原始版本──▶────┘
        │
        └──继续编辑──▶ [草稿] (可再次润色)

梦境隐私状态:
[私密] ◀──切换──▶ [公开]

梦境版本:
[原始版本] ──AI润色──▶ [润色版本v1] ──编辑原始──▶ [原始版本v2] ──再次润色──▶ [润色版本v2]
    │                      │                           │                          │
    └──────────────────────┴───────────可随时切换─────┴──────────────────────────┘

任务状态:
[待完成] ──打卡──▶ [已完成]
    │
    └──过期──▶ [已过期]

特权状态（通过积分兑换或连续打卡获得，无付费）:
[普通用户] ──积分兑换/连续打卡7天──▶ [特权用户] ──过期──▶ [普通用户]
```

## 4. 页面信息架构

### 4.1 页面层级

```
梦见小程序
├── 首页 (pages/index)
│   ├── 记梦按钮
│   ├── 连续记梦天数
│   └── 昨日解析回顾
│
├── 记录梦境页 (pages/record)
│   ├── 梦境输入区
│   ├── AI润色按钮 (新增)
│   ├── 版本切换 (原始/润色) (新增)
│   ├── 版本历史入口 (新增)
│   ├── 隐私设置开关 (新增)
│   ├── 标签选择器
│   ├── 情绪选择器
│   └── 提交按钮
│
├── 梦境版本历史页 (pages/dream-versions) (新增)
│   ├── 版本时间线
│   ├── 原始版本列表
│   ├── 润色版本列表
│   └── 版本对比
│
├── 探索页面 (pages/explore) (新增)
│   ├── 公开梦境流
│   ├── 随机探索按钮
│   ├── 筛选器 (标签/情绪)
│   └── 梦境卡片列表
│
├── 解析结果页 (pages/result)
│   ├── 梦境主题
│   ├── 心理解读
│   ├── 今日运势
│   ├── 改运任务
│   └── 分享按钮
│
├── 我的页面 (pages/profile)
│   ├── 梦境日历
│   ├── 成就展示
│   ├── 幸运值统计
│   ├── 会员入口
│   └── 设置入口
│
├── 梦境详情页 (pages/dream-detail)
│   ├── 梦境内容 (显示当前选择的版本)
│   ├── 版本切换按钮 (新增)
│   ├── 隐私状态标识 (新增)
│   └── 相关解析
│
├── 权益中心页面 (pages/vip)
│   ├── 积分展示
│   ├── 积分获取方式
│   ├── 可享权益列表
│   └── 积分兑换（无付费）
│
└── 设置页面 (pages/settings)
    ├── 消息提醒
    ├── 隐私设置
    └── 关于我们
```

### 4.2 导航结构

```
底部 TabBar:
┌──────────────────────────────────────────────────────────┐
│  [首页]      [探索]      [记梦]      [我的]              │
│   🏠          🔍          ✏️          👤                │
└──────────────────────────────────────────────────────────┘
```

## 5. 数据流设计

### 5.1 全局状态管理

```typescript
// 全局状态结构
interface GlobalState {
    user: {
        id: string;
        openId: string;
        nickname: string;
        avatar: string;
        isVip: boolean;
        vipExpireAt: string;
        luckyPoints: number;
        consecutiveDays: number;
    };
    dream: {
        currentDream: Dream | null;
        currentVersion: 'original' | 'polished'; // 新增：当前查看的版本
        dreamList: Dream[];
        todayAnalysis: Analysis | null;
    };
    explore: {
        // 新增：探索模块状态
        publicDreams: Dream[];
        currentFilter: ExploreFilter;
        hasMore: boolean;
    };
    task: {
        todayTask: Task | null;
        taskHistory: Task[];
    };
    config: {
        tags: Tag[];
        emotions: Emotion[];
    };
}
```

### 5.2 数据同步策略

| 数据类型       | 同步策略                     | 缓存时间  |
| -------------- | ---------------------------- | --------- |
| 用户信息       | 登录时拉取，本地缓存         | 24小时    |
| 梦境列表       | 增量同步                     | 实时      |
| **梦境版本**   | **按需加载，版本切换时拉取** | **永久**  |
| **公开梦境流** | **分页加载，下拉刷新**       | **5分钟** |
| 解析结果       | 按需加载                     | 永久      |
| 配置数据       | 启动时加载                   | 24小时    |
| 任务数据       | 实时同步                     | 不缓存    |

## 6. 权限与安全

### 6.1 权限控制

| 功能               | 游客 | 普通用户         | 特权用户（积分兑换） |
| ------------------ | ---- | ---------------- | -------------------- |
| 记录梦境           | ❌   | ✅               | ✅                   |
| **AI润色**         | ❌   | **每日3次**      | **无限次**           |
| **查看版本历史**   | ❌   | **最近10个版本** | **全部版本**         |
| **浏览公开梦境**   | ✅   | ✅               | ✅                   |
| **发布公开梦境**   | ❌   | ✅               | ✅                   |
| 查看解析(需看广告) | ❌   | ✅               | ❌                   |
| 查看解析(免广告)   | ❌   | ❌               | ✅                   |
| 历史梦境查看       | ❌   | 最近30天         | 全部                 |
| 再次解析           | ❌   | 消耗积分         | 免费                 |
| 深度解析           | ❌   | ❌               | ✅                   |

**特权获取方式（无付费）**：

- 积分兑换：50积分/1天、280积分/7天、900积分/30天
- 连续打卡：连续记梦7天自动获得1天免广告特权
- 成就奖励：特定成就解锁可获得特权天数

### 6.2 数据安全

- 梦境内容加密存储
- 敏感词过滤
- 用户隐私数据脱敏
- **公开梦境审核机制** (新增)
- **用户可随时修改梦境隐私状态** (新增)
- **版本历史加密存储，仅用户本人可访问** (新增)
- 访问日志审计

## 7. 性能指标

### 7.1 页面加载

| 页面           | 首次加载目标 | 二次加载目标 |
| -------------- | ------------ | ------------ |
| 首页           | < 2s         | < 0.5s       |
| 记录页         | < 1.5s       | < 0.3s       |
| **探索页**     | **< 2s**     | **< 0.5s**   |
| **版本历史页** | **< 1.5s**   | **< 0.3s**   |
| 解析结果页     | < 3s         | < 0.5s       |
| 我的页面       | < 2s         | < 0.5s       |

### 7.2 接口响应

| 接口类型       | 响应时间目标 |
| -------------- | ------------ |
| 用户信息       | < 200ms      |
| 梦境记录       | < 500ms      |
| **AI润色**     | **< 8s**     |
| **版本切换**   | **< 300ms**  |
| **公开梦境流** | **< 500ms**  |
| AI解析         | < 5s         |
| 任务打卡       | < 300ms      |

## 8. 埋点规划

### 8.1 核心事件

| 事件名                   | 触发时机           | 参数                                   |
| ------------------------ | ------------------ | -------------------------------------- |
| app_launch               | 小程序启动         | scene, referrer                        |
| dream_record_start       | 开始记录梦境       | -                                      |
| dream_record_submit      | 提交梦境           | word_count, tags, emotion, is_public   |
| **polish_click**         | **点击AI润色按钮** | **dream_id**                           |
| **polish_complete**      | **AI润色完成**     | **dream_id, duration**                 |
| **version_switch**       | **切换版本**       | **dream_id, from_version, to_version** |
| **version_history_view** | **查看版本历史**   | **dream_id, version_count**            |
| **privacy_toggle**       | **切换隐私状态**   | **dream_id, is_public**                |
| **explore_enter**        | **进入探索页**     | **source**                             |
| **explore_random**       | **点击随机探索**   | **-**                                  |
| **explore_dream_view**   | **查看公开梦境**   | **dream_id, author_id**                |
| **explore_filter**       | **使用筛选器**     | **filter_type, filter_value**          |
| ad_show                  | 广告展示           | ad_type, position                      |
| ad_complete              | 广告观看完成       | ad_type, duration                      |
| analysis_view            | 查看解析结果       | dream_id                               |
| task_complete            | 完成任务           | task_id, task_type                     |
| share_click              | 点击分享           | share_type, content_type               |
| privilege_click          | 点击权益中心入口   | source                                 |
| privilege_exchange       | 积分兑换权益       | plan_type, points_cost                 |
