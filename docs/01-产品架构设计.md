# 梦见小程序 - 产品架构设计

## 1. 系统架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  微信小程序  │  │   H5 端     │  │  其他平台   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        网关层 (API Gateway)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   认证鉴权   │  │   限流控制   │  │   日志记录   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        业务服务层                                │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 用户服务  │ │ 梦境服务  │ │ 解析服务  │ │ 任务服务  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                        │
│  │ 积分服务  │ │ 广告服务  │ │ 会员服务  │                        │
│  └──────────┘ └──────────┘ └──────────┘                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  MySQL   │  │ MongoDB  │  │  Redis   │  │   OSS    │        │
│  │ 用户/配置 │  │ 梦境文本  │  │   缓存   │  │ 静态资源  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        第三方服务                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 微信开放  │  │ AI大模型  │  │ 广告平台  │  │ 消息推送  │        │
│  │  平台    │  │   API    │  │   SDK   │  │   服务   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 功能模块划分

### 2.1 模块关系图

```
                    ┌──────────────┐
                    │    首页      │
                    │  (入口模块)   │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │ 梦境记录  │    │ 梦境日历  │    │ 个人中心  │
    │  模块    │    │   模块   │    │   模块   │
    └────┬─────┘    └──────────┘    └────┬─────┘
         │                               │
         ▼                               ▼
    ┌──────────┐                   ┌──────────┐
    │ AI解析   │                   │ 会员系统  │
    │  模块    │                   │   模块   │
    └────┬─────┘                   └──────────┘
         │
         ▼
    ┌──────────┐
    │ 改运任务  │
    │  模块    │
    └────┬─────┘
         │
         ▼
    ┌──────────┐
    │ 积分系统  │
    │  模块    │
    └──────────┘
```

### 2.2 核心模块说明

| 模块 | 职责 | 依赖模块 |
|------|------|----------|
| 用户模块 | 登录、注册、用户信息管理 | 微信登录 |
| 梦境记录模块 | 梦境输入、标签选择、情绪标记 | 用户模块 |
| AI解析模块 | 调用大模型生成解析结果 | 梦境模块、广告模块 |
| 梦境日历模块 | 历史记录展示、连续打卡统计 | 梦境模块 |
| 改运任务模块 | 任务展示、完成打卡 | 解析模块、积分模块 |
| 积分系统模块 | 积分获取、消耗、记录 | 任务模块、会员模块 |
| 广告模块 | 激励视频、Banner广告 | 微信广告SDK |
| 会员模块 | 会员开通、权益管理 | 支付模块 |

## 3. 用户流程设计

### 3.1 核心用户旅程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  打开   │───▶│  记录   │───▶│  观看   │───▶│  查看   │───▶│  完成   │
│ 小程序  │    │  梦境   │    │  广告   │    │  解析   │    │  任务   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
     │                                             │              │
     │                                             ▼              ▼
     │                                       ┌─────────┐    ┌─────────┐
     │                                       │  分享   │    │  获得   │
     │                                       │  结果   │    │  积分   │
     │                                       └─────────┘    └─────────┘
     │
     ▼
┌─────────┐    ┌─────────┐
│  查看   │───▶│  历史   │
│  日历   │    │  回顾   │
└─────────┘    └─────────┘
```

### 3.2 状态流转

```
梦境状态:
[草稿] ──提交──▶ [待解析] ──解析中──▶ [已解析] ──删除──▶ [已删除]

任务状态:
[待完成] ──打卡──▶ [已完成]
    │
    └──过期──▶ [已过期]

会员状态:
[普通用户] ──付费──▶ [VIP会员] ──过期──▶ [普通用户]
```

## 4. 页面信息架构

### 4.1 页面层级

```
梦见小程序
├── 首页 (pages/index)
│   ├── 记梦按钮
│   ├── 连续记梦天数
│   └── 昨日解析回顾
│
├── 记录梦境页 (pages/record)
│   ├── 梦境输入区
│   ├── 标签选择器
│   ├── 情绪选择器
│   └── 提交按钮
│
├── 解析结果页 (pages/result)
│   ├── 梦境主题
│   ├── 心理解读
│   ├── 今日运势
│   ├── 改运任务
│   └── 分享按钮
│
├── 我的页面 (pages/profile)
│   ├── 梦境日历
│   ├── 成就展示
│   ├── 幸运值统计
│   ├── 会员入口
│   └── 设置入口
│
├── 梦境详情页 (pages/dream-detail)
│   └── 历史梦境内容
│
├── 会员页面 (pages/vip)
│   ├── 会员权益
│   └── 购买选项
│
└── 设置页面 (pages/settings)
    ├── 消息提醒
    ├── 隐私设置
    └── 关于我们
```

### 4.2 导航结构

```
底部 TabBar:
┌──────────────────────────────────────────────┐
│  [首页]      [记梦]      [我的]              │
│   🏠           ✏️          👤                │
└──────────────────────────────────────────────┘
```

## 5. 数据流设计

### 5.1 全局状态管理

```typescript
// 全局状态结构
interface GlobalState {
  user: {
    id: string
    openId: string
    nickname: string
    avatar: string
    isVip: boolean
    vipExpireAt: string
    luckyPoints: number
    consecutiveDays: number
  }
  dream: {
    currentDream: Dream | null
    dreamList: Dream[]
    todayAnalysis: Analysis | null
  }
  task: {
    todayTask: Task | null
    taskHistory: Task[]
  }
  config: {
    tags: Tag[]
    emotions: Emotion[]
  }
}
```

### 5.2 数据同步策略

| 数据类型 | 同步策略 | 缓存时间 |
|----------|----------|----------|
| 用户信息 | 登录时拉取，本地缓存 | 24小时 |
| 梦境列表 | 增量同步 | 实时 |
| 解析结果 | 按需加载 | 永久 |
| 配置数据 | 启动时加载 | 24小时 |
| 任务数据 | 实时同步 | 不缓存 |

## 6. 权限与安全

### 6.1 权限控制

| 功能 | 游客 | 普通用户 | VIP用户 |
|------|------|----------|---------|
| 记录梦境 | ❌ | ✅ | ✅ |
| 查看解析(需看广告) | ❌ | ✅ | ❌ |
| 查看解析(免广告) | ❌ | ❌ | ✅ |
| 历史梦境查看 | ❌ | 最近30天 | 全部 |
| 再次解析 | ❌ | 消耗积分 | 免费 |
| 高级解析主题 | ❌ | ❌ | ✅ |

### 6.2 数据安全

- 梦境内容加密存储
- 敏感词过滤
- 用户隐私数据脱敏
- 访问日志审计

## 7. 性能指标

### 7.1 页面加载

| 页面 | 首次加载目标 | 二次加载目标 |
|------|--------------|--------------|
| 首页 | < 2s | < 0.5s |
| 记录页 | < 1.5s | < 0.3s |
| 解析结果页 | < 3s | < 0.5s |
| 我的页面 | < 2s | < 0.5s |

### 7.2 接口响应

| 接口类型 | 响应时间目标 |
|----------|--------------|
| 用户信息 | < 200ms |
| 梦境记录 | < 500ms |
| AI解析 | < 5s |
| 任务打卡 | < 300ms |

## 8. 埋点规划

### 8.1 核心事件

| 事件名 | 触发时机 | 参数 |
|--------|----------|------|
| app_launch | 小程序启动 | scene, referrer |
| dream_record_start | 开始记录梦境 | - |
| dream_record_submit | 提交梦境 | word_count, tags, emotion |
| ad_show | 广告展示 | ad_type, position |
| ad_complete | 广告观看完成 | ad_type, duration |
| analysis_view | 查看解析结果 | dream_id |
| task_complete | 完成任务 | task_id, task_type |
| share_click | 点击分享 | share_type, content_type |
| vip_click | 点击会员入口 | source |
| vip_purchase | 完成会员购买 | plan_type, price |
